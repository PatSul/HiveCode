name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - 'hive/**'

permissions:
  contents: write

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          latest=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$latest" ]; then
            latest="v0.0.0"
          fi
          echo "tag=$latest" >> "$GITHUB_OUTPUT"
          echo "Latest tag: $latest"

      - name: Bump patch version
        id: bump
        run: |
          tag="${{ steps.latest_tag.outputs.tag }}"
          # Strip 'v' prefix
          version="${tag#v}"
          # Split into parts
          major=$(echo "$version" | cut -d. -f1)
          minor=$(echo "$version" | cut -d. -f2)
          patch=$(echo "$version" | cut -d. -f3)
          # Bump patch
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          new_tag="v$new_version"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "Bumping $tag -> $new_tag"

      - name: Update Cargo.toml versions
        run: |
          new_version="${{ steps.bump.outputs.version }}"
          for toml in hive/crates/*/Cargo.toml; do
            sed -i "s/^version = \"[0-9]*\.[0-9]*\.[0-9]*\"/version = \"$new_version\"/" "$toml"
          done
          echo "Updated all crate versions to $new_version"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hive/crates/*/Cargo.toml
          if git diff --cached --quiet; then
            echo "No version changes to commit"
          else
            git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
            git push
          fi

      - name: Create and push tag
        run: |
          git tag "${{ steps.bump.outputs.tag }}"
          git push origin "${{ steps.bump.outputs.tag }}"
          echo "Created and pushed tag ${{ steps.bump.outputs.tag }}"

      - name: Trigger Release workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Tags pushed by GITHUB_TOKEN don't trigger other workflows,
          # so we explicitly dispatch the Release workflow.
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/release.yml/dispatches" \
            -d '{"ref":"${{ steps.bump.outputs.tag }}","inputs":{"tag":"${{ steps.bump.outputs.tag }}"}}'
          echo "Dispatched Release workflow for ${{ steps.bump.outputs.tag }}"
